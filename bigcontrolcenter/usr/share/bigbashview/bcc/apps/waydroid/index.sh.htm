#!/bin/bash

#Translation
export TEXTDOMAINDIR="/usr/share/locale"
export TEXTDOMAIN=bigcontrolcenter

# Don't group windows
xprop -id "$(xprop -root '\t$0' _NET_ACTIVE_WINDOW | cut -f 2)" -f WM_CLASS 8s -set WM_CLASS "$$"

FOLDER_CONFIG="$HOME/.config/waydroid"
mkdir -p ~/.config/waydroid

REMOVE=$"Remover"
MAXIMIZED=$"Maximizado"
UNINSTALL=$"Desinstalar"
RESOLUTION="$(cat ${FOLDER_CONFIG}/resolution)"

if [ "$RESOLUTION" = "" ]; then
    RESOLUTION="0"
    echo "$RESOLUTION" > ${FOLDER_CONFIG}/resolution
fi

# Import BigControlCenter base modules / Importa os módulos básicos do BigControlCenter
# That's include jquery and materialize / Isso inclui o jquery e o materialize
# http://materializecss.com/


cat << EOF

<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">

EOF
 
    echo '<title>' $"Waydroid" '</title>'

cat << EOF
    <script type="text/javascript" src="/usr/share/bigbashview/bcc/materialize/js/jquery.js"></script>
  <link rel="stylesheet" href="./style2.css">
</head>
EOF

# Get body tag with color light or not
/usr/share/bigbashview/bcc/shell/getbgcolor.sh

OIFS=$IFS
IFS=$'\n'

cat << EOF

<div class="dark-light">
  <svg viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5" fill="none" stroke-linecap="round" stroke-linejoin="round">
    <path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z" />
  </svg>
</div>


<div class="login">
  <div class="wrap">
    <div class="user">

      <div class="logo">
        <a href="#"><img src="logo-big-trans-branco.png" class="logo-biglinux"></a>
      </div>

      
        <div class="form-wrap"> 
          <div class="form-wrap tabs-content">
          
EOF
  echo '<h2><img src="icon.png" style="width: 48px;"><br>'
#   echo $"Waydroid"
  echo '</h2>'
cat << EOF   
          
          </div>
          
          <!-- TABS CONTENT -->
          <div class="tabs-content">
            <!-- INICIO TABS CONTENT LIST -->
            <div id="list-tab-content" class="fc-card active">

                <div id="desc">
EOF


echo $"Utilize programas para Android no BigLinux."
echo "<br><br>"
#echo $"Com o Waydroid é possível instalar programas no formato .apk diretamente do gerenciador de arquivos.<br><br>"

if [ ! -e "/usr/bin/waydroid-big" ]; then


INSTALL_WAYDROID=$"Instalar o Waydroid"
INSTALL_WAYDROID_WITH_GAPPS=$"Instalar o Waydroid com Google Apps"

echo '<br><br>'
echo '<div class="apps-card" style="margin-left: 10px; margin-right: 10px; display: inline-flex;">'

cat << EOF
        <div class=app-card>
          <a class="content-button status-button" style="margin-left: 10px; margin-right: 10px;" href="make.sh.htm?install_with_gapps=1">$INSTALL_WAYDROID_WITH_GAPPS</a>
        </div>
EOF

cat << EOF
        <div class=app-card>
          <a class="content-button status-button" style="margin-left: 10px; margin-right: 10px;" href="make.sh.htm?install=1">$INSTALL_WAYDROID</a>
        </div>
EOF

cat << EOF
    </p>
  </div>
EOF


cat << EOF
  <div class="help-action">
    <p style='font-size:14px;'>
EOF

  echo $"Este download tem aproximadamente 1 GB, dependendo da sua conexão pode demorar."
    

else


################
# Open to verify if /run/waydroid-lxc/dnsmasq.pid exist using http status, 200 ok, 500 not exist
################
FileToVerify="/run/waydroid-lxc/dnsmasq.pid"
if [ -e $FileToVerify ]; then
  Previous=200
else
  Previous=500
fi

# Add checksum automatic reload
cat << EOF

<script type="text/javascript">
// Read file first time
  previous = '$Previous';

// Loop to verify if file is changed
setInterval(function() {
    var ajax = new XMLHttpRequest();
    ajax.onreadystatechange = function() {
            if (this.status != previous && this.status != '0') {
                //Reload if file is changed
                previous = this.status;
                document.location.reload(true);
            }
        
    };
    ajax.open("POST", "$FileToVerify", false);
    ajax.send();
}, 2000);
</script>
EOF
################
# Close to verify if /run/waydroid-lxc/dnsmasq.pid exist
################


cat << EOF
<div class="content-section" style="margin-top: 0px;">               
  <ul style="margin-top: 0px;">
  
    <li>
      <div class="products">
        <svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="chrome" role="img" viewBox="0 0 576 512" class="svg-inline--fa fa-chrome fa-w-16 fa-3x"><path fill="currentColor" d="M528 0h-480C21.5 0 0 21.5 0 48v320C0 394.5 21.5 416 48 416h192L224 464H152C138.8 464 128 474.8 128 488S138.8 512 152 512h272c13.25 0 24-10.75 24-24s-10.75-24-24-24H352L336 416h192c26.5 0 48-21.5 48-48v-320C576 21.5 554.5 0 528 0zM512 352H64V64h448V352z"></path></svg>
        Resolução
      </div>
      <!--<span class="status">
        <span class="status-circle green"></span>
        http://www.gmail.com </span>
      <svg viewBox="0 0 496 512" style="width: 20px;"><path fill="currentColor" d="M131.5 217.5L55.1 100.1c47.6-59.2 119-91.8 192-92.1 42.3-.3 85.5 10.5 124.8 33.2 43.4 25.2 76.4 61.4 97.4 103L264 133.4c-58.1-3.4-113.4 29.3-132.5 84.1zm32.9 38.5c0 46.2 37.4 83.6 83.6 83.6s83.6-37.4 83.6-83.6-37.4-83.6-83.6-83.6-83.6 37.3-83.6 83.6zm314.9-89.2L339.6 174c37.9 44.3 38.5 108.2 6.6 157.2L234.1 503.6c46.5 2.5 94.4-7.7 137.8-32.9 107.4-62 150.9-192 107.4-303.9zM133.7 303.6L40.4 120.1C14.9 159.1 0 205.9 0 256c0 124 90.8 226.7 209.5 244.9l63.7-124.8c-57.6 10.8-113.2-20.8-139.5-72.5z"/></svg>              

      -->
      <div class="button-wrapper">
EOF
#################
# Resolução
#################

echo '<select class=RESOLUTION id=RESOLUTION name=RESOLUTION style="cursor: pointer;">'

echo '<option class="optionGroup" selected disabled>Landscape</option>'

for i  in "640x360" "640x480" "800x480" "854x480" "800x600" "960x540" "960x640" "1024x600" "1024x768" "1280x720" "1920x1080" "6000x6000"; do

    if [ "$i" = "6000x6000" ]; then
      name="$MAXIMIZED"
    else
      name="$i"
    fi
		
	if [ "$i" = "$RESOLUTION" ]; then
        echo "<option value=\"$i\" selected>$name</option>"
	else
	    echo "<option value=\"$i\">$name</option>"
	fi

done

echo '<option class="optionGroup" selected disabled>Portrait</option>'
for i  in "360x640" "600x1024" "640x1136" "960x1704" "1080x1920" "6000x6000"; do

    if [ "$i" = "6000x6000" ]; then
      name="$MAXIMIZED"
    else
      name="$i"
    fi
		
	if [ "$i" = "$RESOLUTION" ]; then
        echo "<option value=\"$i\" selected>$name</option>"
	else
	    echo "<option value=\"$i\">$name</option>"
	fi

done
echo '</select>'
cat << EOF

      </div>
    </li>
    
    
    <li>
      <div class="products">
        <svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="chrome" role="img" viewBox="0 0 512 512" class="svg-inline--fa fa-chrome fa-w-16 fa-3x"><path fill="currentColor" d="M234.5 5.709C248.4 .7377 263.6 .7377 277.5 5.709L469.5 74.28C494.1 83.38 512 107.5 512 134.6V377.4C512 404.5 494.1 428.6 469.5 437.7L277.5 506.3C263.6 511.3 248.4 511.3 234.5 506.3L42.47 437.7C17 428.6 0 404.5 0 377.4V134.6C0 107.5 17 83.38 42.47 74.28L234.5 5.709zM256 65.98L82.34 128L256 190L429.7 128L256 65.98zM288 434.6L448 377.4V189.4L288 246.6V434.6z"></path></svg>
        Aceleração 3D
      </div>

EOF
ENABLE_GPU=$"Desativado"
DISABLE_GPU=$"Ativado"

tooltiprun=$"O Waydroid também pode ser iniciado utilizando o menu do sistema"
tooltipgpu=$"Se a aceleração 3D estiver ativada em um hardware incompatível o android não passará da tela de loading"

if [ "$(waydroid-big-3d | grep DISABLED)" != "" ]; then

cat << EOF

  <!--<div class="txt">$tooltipgpu</div>-->
  
  <!--
  <span class="status">
    <span class="status-circle gray"></span>
  <label for="s1" onclick="location.href='make.sh.htm?gpu=1">$ENABLE_GPU</label> </span>
  -->

  <div class="button-wrapper">
  <input id="s1" type="checkbox" onclick="location.href='make.sh.htm?gpu=1';" class="switch">
  
EOF

else

cat << EOF

  <div class="txt">$tooltipgpu</div>

  <!--
  <span class="status">
    <span class="status-circle green"></span>
  <label for="s1" onclick="location.href='make.sh.htm?gpu=0">$DISABLE_GPU</label> </span>
  -->

  <div class="button-wrapper">
  <input id="s1" type="checkbox" onclick="location.href='make.sh.htm?gpu=0';" class="switch" checked>
  
EOF

fi      
cat << EOF
      
      </div>
    </li>
EOF
if [ "$(pacman -Q waydroid-image-gapps 2> /dev/null)" != "" ]; then #START Checks if the waydroid-image-gapps package is installed.

  if [ "$(waydroid status | grep Session | grep RUNNING)" != "" ] || [ "$(ps -e | grep waydroid-big)" != "" ]; then

SHOW_ID=$"Exibir ID do Android"
ACTIVATE=$"Ativar Google Apps"

cat << EOF    
<li>
  <div class="products">
    <svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="chrome" role="img" viewBox="0 0 512 512" class="svg-inline--fa fa-chrome fa-w-16 fa-3x"><path fill="currentColor" d="M325.3 234.3L104.6 13l280.8 161.2-60.1 60.1zM47 0C34 6.8 25.3 19.2 25.3 35.3v441.3c0 16.1 8.7 28.5 21.7 35.3l256.6-256L47 0zm425.2 225.6l-58.9-34.1-65.7 64.5 65.7 64.5 60.1-34.1c18-14.3 18-46.5-1.2-60.8zM104.6 499l280.8-161.2-60.1-60.1L104.6 499z"></path></svg>
    PlayStore
  </div>
  
  <div class="txt">
    <a href="#" class="status-remove"><svg viewBox="0 0 512 512" style="width: 16px; border-radius: 0px; margin: 0px; position: relative; top: -11px;"><path fill="currentcolor" d="M256 0C114.6 0 0 114.6 0 256s114.6 256 256 256s256-114.6 256-256S397.4 0 256 0zM256 400c-18 0-32-14-32-32s13.1-32 32-32c17.1 0 32 14 32 32S273.1 400 256 400zM325.1 258L280 286V288c0 13-11 24-24 24S232 301 232 288V272c0-8 4-16 12-21l57-34C308 213 312 206 312 198C312 186 301.1 176 289.1 176h-51.1C225.1 176 216 186 216 198c0 13-11 24-24 24s-24-11-24-24C168 159 199 128 237.1 128h51.1C329 128 360 159 360 198C360 222 347 245 325.1 258z"/></svg></a>
  </div>

    
  <div class="button-wrapper">
      <ul>
        <li style="font-size: 14px; cursor: pointer;" onclick="_run('./number.run')"><svg viewBox="0 0 384 512" style="width: 12px; border-radius: 0px; margin: 0px 5px -5px 0px;"><path fill="currentcolor" d="M336 0h-288c-26.51 0-48 21.49-48 48v416C0 490.5 21.49 512 48 512h288c26.51 0 48-21.49 48-48v-416C384 21.49 362.5 0 336 0zM192 128c35.35 0 64 28.65 64 64s-28.65 64-64 64S128 227.3 128 192S156.7 128 192 128zM288 384H96c-8.836 0-16-7.164-16-16C80 323.8 115.8 288 160 288h64c44.18 0 80 35.82 80 80C304 376.8 296.8 384 288 384z"/></svg> $SHOW_ID</li>
        <li style="font-size: 14px; cursor: pointer;" onclick="_run('./activate.run')"><svg viewBox="0 0 488 512" style="width: 12px; border-radius: 0px; margin: 0px 5px -3px 0px;"><path fill="currentcolor" d="M488 261.8C488 403.3 391.1 504 248 504 110.8 504 0 393.2 0 256S110.8 8 248 8c66.8 0 123 24.5 166.3 64.9l-67.5 64.9C258.5 52.6 94.3 116.6 94.3 256c0 86.5 69.1 156.6 153.7 156.6 98.2 0 135-70.4 140.8-106.9H248v-85.3h236.1c2.3 12.7 3.9 24.9 3.9 41.4z"/></svg> $ACTIVATE</li>
      </ul>  
  </div>
  <div class="pop-up">
      <div class="pop-up__title">Ajuda - Habilitar PlayStore
        <svg class="close" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-x-circle">
          <circle cx="12" cy="12" r="10" />
          <path d="M15 9l-6 6M9 9l6 6" />
        </svg>

      </div>

      <div class="pop-up__subtitle" style="text-align: justify;">
EOF
  echo $'Para ativar a PlayStore é necessário clicar em (Exibir ID do Android) e copiar o ID do Android, em seguida clique em (Ativar Google Apps) para abrir a página de Registro do dispositivo, precisa estar logado na sua conta Google, insira seu ID do Android e faça o registro. Pode demorar alguns minutos para ativar no seu Waydroid. Feche e abra novamente. Pronto!'
cat << EOF
      </div>
  </div> 
</li>

EOF
  fi
  
fi #END Checks if the waydroid-image-gapps package is installed.

if [ -e "$HOME/.local/share/waydroid" ]; then
cat << EOF

  <li>
    <div class="products">
      <svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="chrome" role="img" viewBox="0 0 448 512" class="svg-inline--fa fa-chrome fa-w-16 fa-3x"><path fill="currentColor" d="M480 416C497.7 416 512 430.3 512 448C512 465.7 497.7 480 480 480H150.6C133.7 480 117.4 473.3 105.4 461.3L25.37 381.3C.3786 356.3 .3786 315.7 25.37 290.7L258.7 57.37C283.7 32.38 324.3 32.38 349.3 57.37L486.6 194.7C511.6 219.7 511.6 260.3 486.6 285.3L355.9 416H480zM265.4 416L332.7 348.7L195.3 211.3L70.63 336L150.6 416L265.4 416z"></path></svg>
EOF
    echo $"Remover Configurações"
cat << EOF      
    </div>
    
    <div class="button-wrapper">
        <div class=app-card>
            <a class="content-button status-button" href="make.sh.htm?remove=1">$REMOVE</a>
        </div> 
    </div>
  </li>
EOF
fi

cat << EOF

  <li>
    <div class="products">
      <svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="chrome" role="img" viewBox="0 0 448 512" class="svg-inline--fa fa-chrome fa-w-16 fa-3x"><path fill="currentColor" d="M135.2 17.69C140.6 6.848 151.7 0 163.8 0H284.2C296.3 0 307.4 6.848 312.8 17.69L320 32H416C433.7 32 448 46.33 448 64C448 81.67 433.7 96 416 96H32C14.33 96 0 81.67 0 64C0 46.33 14.33 32 32 32H128L135.2 17.69zM394.8 466.1C393.2 492.3 372.3 512 346.9 512H101.1C75.75 512 54.77 492.3 53.19 466.1L31.1 128H416L394.8 466.1z"></path></svg>
EOF
    echo $"Desinstalar o Waydroid"
cat << EOF
    </div>
    
    <div class="button-wrapper">
        <div class=app-card>
            <a class="content-button status-button" href="make.sh.htm?uninstall=1">$UNINSTALL</a>
        </div> 
    </div>
  </li>
EOF

cat << EOF

  </ul>
</div>
<br>
EOF
#if [ "$(waydroid status | grep Session | grep RUNNING)" != "" ] || [ "$(ps -e | grep waydroid-big)" != "" ]; then
if [ "$(waydroid-big-3d | grep ENABLED)" != "" -a "$(lsmod | grep nvidia_drm)" != "" ]; then

cat << EOF

<div class="help-action">
  <p style='font-size:14px;'>
EOF
    echo $"Aceleração 3D é incompatível em placas de vídeo Nvidia utilizando o driver proprietário."
cat << EOF
  </p>
</div>
EOF
fi
cat << EOF
<br>
<div style="text-align: center; display:inline-block;">
EOF
    tooltiprun=$"O Waydroid também pode ser iniciado utilizando o menu do sistema"
    tooltipgpu=$"Se a aceleração 3D estiver ativada em um hardware incompatível<br> o android não passará da tela de loading"

    STOP_WAYDROID=$"Parar o Waydroid"
    START_WAYDROID=$"Iniciar o Waydroid"

    if [ "$(waydroid status | grep Session | grep RUNNING)" != "" ] || [ "$(ps -e | grep waydroid-big)" != "" ]; then
    

    cat << EOF
            <div class=app-card>
              <a class="content-button status-button" href="make.sh.htm?stop=1">$STOP_WAYDROID</a>
            </div>
EOF

    else

    cat << EOF
            <div class=app-card>
              <a class="content-button status-button" href="make.sh.htm?start=1">$START_WAYDROID</a>
            </div>
EOF
    fi
fi    
cat << EOF
</div>                
  <script  src="./script.js"></script>
  <script>
\$('#RESOLUTION').on('change', function() {
    _run('./resolution.run ' + \$(this).find(":selected").val());
});
  </script>

</li>                          
                        </ul>                          
                      </div>
                      
                    </div>
                  </div>
                  <br style="clear: left;" />
                </div>
              </div>


            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

EOF



IFS=$OIFS
